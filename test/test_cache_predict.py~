import time
from data.load_dataset import load_iris_dataset
from forest.random_forest import RandomForestC45
from predict_with_cache import RandomForestC45Cached
from sklearn.model_selection import train_test_split

# Загружаем датасет
X, y, attribute_types, feature_names, class_names = load_iris_dataset()

# Разделяем данные на тренировочные и тестовые
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)

# Инициализируем леса
forest_no_cache = RandomForestC45(n_estimators=10, sample_ratio=1, random_state=42)
forest_cached = RandomForestC45Cached(n_estimators=10, sample_ratio=1, random_state=42)

# Обучаем леса
print("=== Обучение лесов ===")
start = time.time()
forest_no_cache.fit(X_train, y_train, attribute_types)
print(f"⏱️ Обучение без кэша: {time.time() - start:.4f} сек")

start = time.time()
forest_cached.fit(X_train, y_train, attribute_types)
print(f"⚡ Обучение с кэшем: {time.time() - start:.4f} сек")

# Тестируем предсказания (несколько запусков для заметной разницы)
n_runs = 5
print(f"\n=== Предсказания без кэша ({n_runs} запусков) ===")
start = time.time()
for _ in range(n_runs):
    _ = forest_no_cache.predict(X_test)
time_no_cache = time.time() - start
print(f"⏱️ Без кэша: {time_no_cache:.4f} сек (среднее на запуск: {time_no_cache/n_runs:.4f} сек)")

print(f"\n=== Предсказания с кэшем ({n_runs} запусков) ===")
start = time.time()
for _ in range(n_runs):
    _ = forest_cached.predict(X_test)
time_cached = time.time() - start
print(f"⚡ С кэшем: {time_cached:.4f} сек (среднее на запуск: {time_cached/n_runs:.4f} сек)")